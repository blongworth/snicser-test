---
title: "Ratio to standard"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

Checking SNICSer ratio to std results against MR's results from Fudger. Using CFAMS070821 and CFAMS103021.

```{r}
library(tidyverse)
library(readxl)
```

Read data for CFAMS070821 and CFAMS103021, combine with SNICSer data. SNICSer data is wheel normalized by setting external standard 14/12 to 1 and 13/12 to 0.9822?? with same number of standards, by time, using self normalization.

```{r}
fudger0708 <- read_xlsx("data/CFAMS070821 Norm Results.xlsx", skip = 5) %>% 
  filter(!Rpts == 0) %>% 
  mutate(wheel = "CFAMS070821")
fudger1030 <- read_xlsx("data/CFAMS1030821 Norm Results.xlsx", skip = 5) %>% 
  filter(!Rpts == 0) %>% 
  mutate(wheel = "CFAMS103021")

fudger <- bind_rows(fudger0708, fudger1030)

snicser_files <- list.files(path = "data", 
                              pattern = "TargetTable.xls",
                              full.names = TRUE)

snicser <- snicser_files %>% 
  set_names() %>% 
  map_dfr(read_tsv, .id = "wheel") %>% 
  mutate(wheel = word(basename(wheel), sep = "_"))

combined <- snicser %>% 
  select(wheel, Pos, SampleName, Typ, N, DelC13, NormRat) %>% 
  left_join(select(fudger, wheel, Pos., fRpts = Rpts, 
                   fdel13C = `del13C to STD`, fnormrat = `Ratio to STD`), 
            by = c("wheel" = "wheel", "Pos" = "Pos.")) %>% 
  filter(!is.na(fnormrat)) %>% 
  mutate(avg_fm = (NormRat + fnormrat) / 2,
         diff = fnormrat - NormRat)
```

### Plots

Plot differences in ratio to standard (fudger - SNICSer). 

```{r}
combined %>% 
ggplot(aes(avg_fm, diff, color = DelC13)) +
  geom_point() +
  labs(title = "Ratio differences between fudger and snicser",
       x = "average ratio",
       y = "fudger - snicser")
```

There are some oddnesses in the differences. The slope of low ratio stuff is interesting; fudger results increasingly higher as ratio increases.
 
#### Largest differences

```{r}
combined %>% 
  select(SampleName, wheel, Pos, Typ, DelC13, SNICSer = NormRat, Fudger = fnormrat, diff) %>% 
  arrange(desc(abs(diff))) %>% 
  head()
```

Distribution of differences in standards is strongly related to D13C.

```{r}
combined %>% 
  filter(Typ == "S") %>% 
  ggplot(aes(diff, DelC13)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point(aes(color = wheel))
  
```

```{r}
combined %>% 
  filter(Typ == "S") %>% 
  ggplot(aes(DelC13, NormRat, color = wheel)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point()
```

```{r}
combined %>% 
  filter(Typ == "S") %>% 
  ggplot(aes(fdel13C, fnormrat, color = wheel)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point()
```

It looks like fudger results for CFAMS103021 use a different value for 13/12 of standard.

```{r}
combined %>% 
  select(wheel, Pos, NormRat, snicser = DelC13, fudger = fdel13C) %>% 
  pivot_longer(cols = c(snicser, fudger), values_to = "d13C", names_to = "analysis") %>% 
  ggplot(aes(Pos, d13C, color = analysis)) +
  geom_point() +
  facet_wrap(~wheel)
```
